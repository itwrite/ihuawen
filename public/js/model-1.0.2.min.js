/**
 * Created by zzpzero on 2017/3/31.
 */
(function(h,q){"object"===typeof module&&"object"===typeof module.exports?module.exports=h.document?q(h,!0):function(h){if(!h.document)throw Error("Model requires a window with a document");return q(h)}:q(h)})("undefined"!==typeof window?window:this,function(h,q){function D(a,b){if("string"==typeof a&&"string"==typeof b)return a.localeCompare(b);if("number"==typeof a&&"string"==typeof b)return-1;if("string"==typeof a&&"number"==typeof b)return 1;if("number"==typeof a&&"number"==typeof b){if(a>b)return 1;
    if(a==b)return 0;if(a<b)return-1}return 0}function t(a,b,c,d){var e=p[0],f=u[0];Object.defineProperty(this,"boolean",{get:function(){return f},set:function(a){f=m.convert_boolean(a)}});Object.defineProperty(this,"operator",{get:function(){return e},set:function(a){e=m.convert_operator(a)}});this.field=a;this.value=c;this.boolean=d;this.operator=b}function v(a){var b=this,c,e=[];Object.defineProperty(this,"boolean",{get:function(){return c},set:function(a){c=m.convert_boolean(a)}});Object.defineProperty(this,
    "conditions",{get:function(){return e}});this.boolean=a;this.where=function(a,b,c,g){if(d.isObject(a)){g=b;for(var f in a)this.where(f,p[0],a[f],g)}else d.isString(a)&&0<String(a).length?2==arguments.length?e.push(new t(a,p[0],b)):e.push(new t(a,b,c,g)):d.isFunction(a)&&(f=new v(b),a.call(f),e.push(f));return this};this.queryString=function(){var a=[];d.each(b.conditions,function(b,c){0<parseInt(b)&&a.push(-1!=d.inArray(c["boolean"],w,0)?" OR ":" AND ");c instanceof v?a.push("("+c.queryString()+")"):
c instanceof t&&(b=c.field,String(c.value).replace(x,y),a.push("`"+b+"`"),a.push(c.operator),a.push(d.isNumber(c.value)?c.value:"'"+("like"==c.operator?"%"+String(c.value)+"%":String(c.value))+"'"))});return a.join(" ")};var g=function(a,b){if(b instanceof v)return b.isMatch(a);if(b instanceof t){var c=b.field,e=b.value,f=!1;if(d.isDefined(a[c]))switch(b.operator){case "=":case "==":f=a[c]==e;break;case "===":f=a[c]===e;break;case "!=":f=a[c]!=e;break;case "<>":case "!==":f=a[c]!==e;break;case "<":case "<<":f=
    a[c]<e;break;case "<=":f=a[c]<=e;break;case ">":case ">>":f=a[c]>e;break;case ">=":f=a[c]>=e;break;case "like":f=function(a,b){var c=!1;d.each(b,function(b,e){if(""!=e&&-1<String(a).indexOf(e))return c=!0,!1});return c}(a[c],String(e).replace(x,y).split("%"));break;default:f=!1}return f}return d.isBoolean(b)?b:!1};this.isMatch=function(a){var b=this.conditions;if(0==b.length)return!0;var c=!1;d.each(b,function(b,e){c=0<parseInt(b)?-1!=d.inArray(e["boolean"],w,0)?c||g(a,e):c&&g(a,e):g(a,e)});return c}}
    var z=!1,A=null,n=[],p="== === < > <= >= <> != << >> like".split(" "),u=["&&","||","|"],E={and:"&&",or:"||"},B=["left","right","inner"],w=["||","|","or"],F=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,x=/\\|'|\r|\n|\u2028|\u2029/g,k=function(a){return new k.fn.init(a)},r=function(){if(1==z){var a=["echo["+((new Date).getTime()-A)/1E3+"s]:"],b;for(b in arguments)a.push(arguments[b]);console.log.apply(this,a)}},G={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},y=function(a){return"\\"+
        G[a]},C={get data(){return n},each:function(){d.each.apply(this,arguments)},sum:function(a,b){var c=0;this.each(b,function(b,g){d.isDefined(g[a])&&(c+=parseFloat(g[a]))});return c}},d={inArray:function(a,b,c){var e;if(b){if([].indexOf)return Array.prototype.indexOf.call(b,a,c);e=b.length;for(c=c?0>c?Math.max(0,e+c):c:0;c<e;c++)if(c in b&&b[c]===a)return c}return-1},typeToString:function(a){return Object.prototype.toString.call(a)},trim:function(a){return null==a?"":(a+"").replace(F,"")},isWindow:function(a){return null!=
        a&&a==a.window},isEmptyObject:function(a){var b=0,c;for(c in a)if(b++,0<b)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==typeof a||a.nodeType||this.isWindow(a))return!1;var c=Object.prototype.hasOwnProperty;try{if(a.constructor&&!c.call(a,"constructor")&&!c.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(b in a);return void 0===b||c.call(a,b)},isArray:function(a){return"[object Array]"==this.typeToString(a)},isDefined:function(a){return"undefined"!=
        typeof a},extend:function(){var a,b,c,e,g,f=arguments[0]||{},l=1,h=arguments.length,k=!1;"boolean"===typeof f&&(k=f,f=arguments[l]||{},l++);"object"===typeof f||d.isFunction(f)||(f={});l===h&&(f=this,l--);for(;l<h;l++)if(null!=(g=arguments[l]))for(e in g)a=f[e],c=g[e],f!==c&&(k&&c&&(d.isPlainObject(c)||(b=d.isArray(c)))?(b?(b=!1,a=a&&d.isArray(a)?a:[]):a=a&&d.isPlainObject(a)?a:{},f[e]=d.extend(k,a,c)):void 0!==c&&(f[e]=c));return f},each:function(a,b){var c,e=0;if(d.isArray(a))for(c=a.length;e<c&&
    !1!==b.call(a[e],e,a[e]);e++);else for(e in a)if(!1===b.call(a[e],e,a[e]))break;return a}};d.each("Arguments Function String Number Date RegExp Error Object Boolean".split(" "),function(a,b){d["is"+b]=function(a){return d.typeToString(a)==="[object "+b+"]"}});var m={extend:function(){d.extend.apply(this,arguments)},split_name:function(a,b){b=b?b:" ";a=d.trim(a.replace(/\s+/g," "));b=a.split(b);a=b[0];return[a,1<b.length?b[1]:a]},convert_join_type:function(a){return-1!=d.inArray(String(a).toLocaleLowerCase(),
        B,0)?a:B[2]},convert_reverse:function(a){return"desc"==String(a).toLocaleLowerCase()||1==a||1==a?1:0},convert_boolean:function(a){a=-1!=d.inArray(a,["and","or"],0)?E[a]:a;return d.isString(a)&&-1<d.inArray(a,u,0)?a:u[0]},convert_operator:function(a){return d.isString(a)&&-1<d.inArray(a,p,0)?a:p[0]},convert_columns:function(a,b){var c=[];b=0<b.length?b:["*"];var e=0,g;for(g in b){var f=b[g];if(d.isString(f))if(f=d.trim(f),/^\s*\*\s*$/gi.test(f)){e++;for(var l in a)c.push({field:l,alias:""})}else f=
        f.replace(/^\s+(as)\s+$/i," as ").split(" as "),c.push({field:f[0],alias:f[1]?f[1]:""});else if(d.isObject(f))for(l in f)c.push({field:l,alias:d.isString(f[l])?f[l]:""})}return c},join:function(a,b,c,e,g,f){var l=[],k=c[0],h=this.groups(c,e);d.each(a,function(a,c){a=c[b];d.isDefined(h[a])?d.each(h[a],function(a,b){d.isFunction(f)&&l.push(d.extend({},f.apply(d,[c,b,!0])))}):-1!=d.inArray(g,["left","right"],0)&&d.isFunction(f)&&l.push(d.extend({},f.apply(d,[c,k,!1])))});return l},groups:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           b,c){var e={};d.each(a,function(a,f){a=f[b];d.isDefined(a)&&(d.isDefined(e[a])||(d.isFunction(c)&&c.call(f,a),e[a]=[]),e[a].push(f))});return e},filter:function(a,b){var c=[];if(0<a.length&&d.isFunction(b))d.each(a,function(a,g){a=b.call(g,g,a);0==a||d.isEmptyObject(a)||c.push(a)});else return a;return c},order_by:function(a,b,c,e){c=0<c?c:0;var g=this,f=[];if(0<b.length&&c<b.length){var l=b[c],h=l.rudder,k=[],m=g.groups(a,l.field,function(a){k.push(a)});if(0<k.length){var n=!1;d.isObject(h)?d.isDefined(h.reverse)&&
    (n=g.convert_reverse(h.reverse)):n=g.convert_reverse(h);k=d.isDefined(h.fx)?k.sort(function(a,b){a=parseFloat(h.fx.call(C,m[a]));b=parseFloat(h.fx.call(C,m[b]));return(a<b?-1:1)*[1,-1][+!!n]}):k.sort(function(a,b){return D(a,b)*[1,-1][+!!n]});d.each(k,function(a,h){a=m[h];a=g.order_by(a,b,c+1,e);d.each(a,function(a,b){f.push(b)})})}else return g.order_by(a,b,c+1,e)}else d.each(a,function(a,b){d.isFunction(e)?f.push(e.call(b,b,a)):f.push(b)});return f},get_row_data:function(a,b){var c={};d.each(b,
        function(b,g){b=g.field;d.isDefined(a[b])&&(c[""==g.alias?g.field:g.alias]=a[b])});return c}};k.fn=k.prototype={model:"1.0.2",constructor:k,extend:function(){return d.extend.apply(this,arguments)},init:function(a){this.clear();n=a;A=(new Date).getTime();return this},debug:function(a){z=a;return this}};k.fn.extend({clear:function(){this.bindings={where:new v("&&"),fields:[],limit:[],order_by:[]};return this},fields:function(a){var b=this;d.isString(a)||d.isObject(a)?b.bindings.fields.push(a):d.isArray(a)&&
    d.each(a,function(a,e){b.fields(e)});return this},join:function(a,b,c,e){e=m.convert_join_type(e);c=m.split_name(c,".");var d=c[0];c=c[1];var f=function(a,b,c){var e={},f;for(f in a)e[f]=a[f];for(var g in b)e[d+"."+g]=1==c?b[g]:null;return e};n="right"==e||"inner"==e&&n.length>b.length?m.join(b,c,n,a,e,f):m.join(n,a,b,c,e,f);r("end of join,data.length:",n.length);return this},order_by:function(a,b){var c=this;d.isArray(a)?d.each(a,function(a,d){c.order_by(d,b)}):d.isObject(a)?d.each(a,function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b){c.order_by(a,b)}):d.isString(a)&&c.bindings.order_by.push({field:a,rudder:b});return this},where:function(a,b,c,e){this.bindings.where.where(a,b,c,e);return this},where_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,p[0],b[c],w[0])},c);return this},where_not_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,"!=",b[c],u[0])},c);return this},where_between:function(a,b,c){d.isArray(b)&&1<b.length&&
    this.where(function(){this.where(a,">",Math.min(b[0],b[1]),c);this.where(a,"<",Math.max(b[0],b[1]),c)},c);return this},where_like:function(a,b,c){this.where(a,"like",b,c);return this},limit:function(a,b){1==arguments.length?this.bindings.limit=[0,Math.max(0,a)]:1<arguments.length&&(this.bindings.limit=[Math.max(0,a),Math.max(0,a+b)]);return this},get:function(){var a=this,b=[],c=m.convert_columns(n[0],a.bindings.fields);0<a.bindings.where.conditions.length&&(b=m.filter(n,function(b){return a.bindings.where.isMatch(b)?
        b:!1}));b=0<a.bindings.order_by.length?m.order_by(b,a.bindings.order_by,0,function(a){return m.get_row_data(a,c)}):m.filter(b,function(a){return m.get_row_data(a,c)});0<a.bindings.limit.length&&(b=b.slice(a.bindings.limit[0],Math.min(a.bindings.limit[1],b.length)));r("List--",b);r("SQL--",this.getSql());a.clear();return b},find:function(a){a=this.where(a).get();return 0<a.length?a[0]:!1},fetch:function(a){var b=this.get();return d.isFunction(a)?(r("fetch begin"),d.each(b,a),r("fetch end"),this):b},
        select:function(a,b){return this.fields(a).where(b).get()},count:function(){return this.get().length},getSql:function(){return this.bindings.where.queryString()}});k.fn.init.prototype=k.fn;k.fn.size=function(){return this.length};"function"===typeof define&&define.amd&&define("model",[],function(){return k});var H=h.Model,I=h.M;k.noConflict=function(a){h.M===k&&(h.M=I);a&&h.Model===k&&(h.Model=H);return k};q||(h.Model=h.M=k);return k});